<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Lovelys å¹¸é‹è½‰è›‹æ©Ÿ</title>
  <style>
    :root {
      --primary: #ff6f91;
      --secondary: #ff9671;
      --accent: #d65db1;
      --bg: #fff0f5;
      
      /* é›»è…¦ç‰ˆé è¨­é«˜åº¦ */
      --slot-height: 180px; 
      --font-size-base: 1.2rem;
    }

    body {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(var(--secondary) 1px, transparent 1px);
      background-size: 20px 20px;
      display: flex;
      justify-content: center;
      align-items: center; /* å‚ç›´ç½®ä¸­ */
      min-height: 100vh;
      margin: 0;
      padding: 15px; /* æ‰‹æ©Ÿç‰ˆé‚Šè· */
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 500px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
      text-align: center;
      position: relative;
    }

    /* === 1. è¼¸å…¥ä»‹é¢ === */
    #start-screen {
      background: white;
      padding: 30px 20px;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(214, 93, 177, 0.2);
      border: 3px solid white;
    }

    h1 {
      color: var(--accent);
      margin-top: 0;
      font-size: 1.8rem;
    }

    p.desc { color: #888; font-size: 0.95rem; margin-bottom: 20px; }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 15px;
      font-size: 1.4rem;
      border: 3px solid #eee;
      border-radius: 15px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--accent);
      outline: none;
      margin-bottom: 20px;
      transition: 0.3s;
      /* é¿å…æ‰‹æ©Ÿè¼¸å…¥æ™‚ç•«é¢æ”¾å¤§ */
      touch-action: manipulation; 
    }

    input:focus { border-color: var(--primary); }

    .btn-draw {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 15px 0;
      width: 100%;
      font-size: 1.2rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(255, 111, 145, 0.4);
      transition: transform 0.2s;
      /* é¿å…æ‰‹æ©Ÿé»æ“Šåç™½ */
      -webkit-tap-highlight-color: transparent; 
    }
    .btn-draw:active { transform: scale(0.96); }
    .btn-draw:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    /* === 2. æ‹‰éœ¸æ©Ÿä»‹é¢ === */
    #slot-machine-area {
      display: none;
      background: var(--accent);
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }

    .machine-title {
      color: white;
      font-size: 1.1rem;
      margin-bottom: 10px;
      font-weight: bold;
      min-height: 1.5em; /* é ç•™é«˜åº¦é¿å…è·³å‹• */
    }

    .slot-container {
      display: flex;
      justify-content: space-between;
      gap: 8px; /* æ»¾è¼ªé–“è· */
      background: #333;
      padding: 8px;
      border-radius: 10px;
      border: 4px solid #fec;
      
      /* â˜… é—œéµï¼šé«˜åº¦æ”¹ç”¨è®Šæ•¸ï¼Œæ–¹ä¾¿æ‰‹æ©Ÿç‰ˆèª¿æ•´ â˜… */
      height: var(--slot-height); 
      overflow: hidden;
      position: relative;
    }

    /* é®ç½©é™°å½± (ç«‹é«”æ„Ÿ) */
    .slot-container::before, .slot-container::after {
      content: '';
      position: absolute;
      left: 0; right: 0;
      height: 20%; /* ç›¸å°é«˜åº¦ */
      z-index: 2;
      pointer-events: none;
    }
    .slot-container::before { top: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent); }
    .slot-container::after { bottom: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); }

    /* ä¸­å¿ƒå°æº–ç·š (è®“ä½¿ç”¨è€…çŸ¥é“è¦çœ‹ä¸­é–“) */
    .win-line {
      position: absolute;
      top: 50%;
      left: -5px;
      right: -5px;
      height: 4px;
      background: rgba(255, 0, 0, 0.5);
      z-index: 3;
      transform: translateY(-50%);
      box-shadow: 0 0 5px red;
      pointer-events: none;
      display: none; /* å¦‚æœè¦ºå¾—ç•«é¢å¤ªäº‚å¯ä»¥éš±è— */
    }

    .reel {
      background: white;
      flex: 1; /* è®“ä¸‰å€‹æ»¾è¼ªå¹³å‡åˆ†é…å¯¬åº¦ */
      border-radius: 5px;
      position: relative;
      overflow: hidden;
    }

    .reel-strip {
      position: absolute;
      top: 0; left: 0; width: 100%;
      /* JS æœƒæ§åˆ¶ transform */
      will-change: transform; /* æ‰‹æ©Ÿæ•ˆèƒ½å„ªåŒ– */
    }

    .slot-item {
      /* â˜… é—œéµï¼šæ¯ä¸€å€‹é …ç›®é«˜åº¦å¿…é ˆç­‰æ–¼å®¹å™¨é«˜åº¦ï¼Œç¢ºä¿ä¸€æ¬¡é¡¯ç¤ºä¸€å€‹ â˜… */
      height: var(--slot-height); 
      display: flex;
      justify-content: center;
      align-items: center;
      
      /* å­—é«”èˆ‡æ’ç‰ˆ */
      font-size: var(--font-size-base);
      font-weight: bold;
      color: #333;
      padding: 5px;
      box-sizing: border-box;
      border-bottom: 1px solid #eee;
      word-wrap: break-word;
      line-height: 1.3;
    }

    /* === 3. çµæœå¡ç‰‡ === */
    #result-card {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: fixed; /* æ”¹ç‚º fixed ç¢ºä¿åœ¨æ‰‹æ©Ÿæœ€ä¸Šå±¤ */
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 85%;
      max-width: 400px;
      z-index: 999;
      animation: popIn 0.5s cubic-bezier(0.17, 0.67, 0.43, 1.45);
    }
    /* èƒŒæ™¯é®ç½© */
    #overlay {
      display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 998;
      backdrop-filter: blur(2px);
    }

    .prize-img {
      width: 100%;
      height: auto;
      max-height: 250px;
      object-fit: contain;
      border-radius: 10px;
      border: 3px solid var(--primary);
      background: #fff;
      margin-bottom: 10px;
    }

    .status-msg { margin-top: 15px; font-weight: bold; min-height: 20px; color: var(--primary); font-size: 0.9rem;}
    .error { color: #e53935; }

    /* === ğŸ“± æ‰‹æ©Ÿç‰ˆå°ˆç”¨èª¿æ•´ (Media Queries) === */
    @media screen and (max-width: 600px) {
      :root {
        /* æ‰‹æ©Ÿç‰ˆç¸®å°é«˜åº¦èˆ‡å­—é«” */
        --slot-height: 120px; 
        --font-size-base: 1rem;
      }
      
      h1 { font-size: 1.5rem; }
      
      .container { padding: 0 10px; }

      .slot-container {
        gap: 5px;
        padding: 5px;
        border-width: 3px;
      }
      
      /* åœ¨æ¥µçª„è¢å¹•(å¦‚ Fold)å¼·åˆ¶æ›è¡Œæˆ–ç¸®å°å­—é«” */
      .slot-item {
        font-size: 0.9rem; 
      }
    }

    /* å‹•ç•« Keyframes */
    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

  <div id="overlay"></div>

  <div class="container">
    
    <div id="start-screen">
      <h1>ğŸ Lovelys æŠ½ç</h1>
      <p class="desc">è«‹è¼¸å…¥åºè™Ÿé–‹å•Ÿå¹¸é‹ä¹‹é–€</p>
      
      <input type="text" id="code-input" placeholder="è¼¸å…¥åºè™Ÿ" maxlength="8" autocomplete="off">
      
      <button id="draw-btn" class="btn-draw">é–‹å§‹æŠ½ç</button>
      <div id="msg-box" class="status-msg"></div>
    </div>

    <div id="slot-machine-area">
      <div id="machine-status" class="machine-title">æº–å‚™å•Ÿå‹•...</div>
      
      <div class="slot-container" id="slot-container-el">
        <div class="win-line"></div>
        
        <div class="reel"><div class="reel-strip" id="reel-1"></div></div>
        <div class="reel"><div class="reel-strip" id="reel-2"></div></div>
        <div class="reel"><div class="reel-strip" id="reel-3"></div></div>
      </div>
    </div>

    <div id="result-card">
      <h2 style="color:var(--secondary); margin:0 0 10px 0; font-size:1.5rem;">ğŸ‰ ä¸­çå•¦ï¼</h2>
      <img id="final-img" class="prize-img" src="" alt="çå“åœ–">
      <h3 id="final-name" style="color:var(--accent); margin:10px 0;">çå“åç¨±</h3>
      <p id="final-detail" style="color:#666; font-size:0.95rem; margin:5px 0;"></p>
      <div style="background:#eee; padding:5px; border-radius:5px; margin-top:10px; display:inline-block;">
        <span style="font-size:0.8rem; color:#888;">åºè™Ÿ: </span>
        <span id="final-code" style="font-family:monospace; font-weight:bold; color:#555;"></span>
      </div>
      <button onclick="location.reload()" class="btn-draw" style="margin-top:20px; font-size:1rem; padding:12px;">å†ç©ä¸€æ¬¡</button>
    </div>

  </div>

  <script>
    // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€ â˜…â˜…â˜…
    const API_URL = 'https://script.google.com/macros/s/AKfycbyfF-yGRiOaEwTfb46Riji-ERnQqjhPL_uJ5rVeekGvI1j4-hmfPu3Jr4MkdeqhfcyHtw/exec';

    // è³‡æ–™æ± 
    const POOL_TYPES = ['é›¨å‚˜å¨ƒ', 'ä¸‰éº—é·—', 'é¾è¦æ‰£', 'è»Ÿç³–', 'å·§å…‹åŠ›', 'é¤…ä¹¾', 'è»Šè»Š', 'æ¨¡å‹åŒ…'];
    const POOL_LOVELYS = ['SAVELY', 'TZUVELY', 'MIVELY', 'JIVELY', 'CHAENG', 'DAHYUN', 'NAYEON', 'JEONG'];

    // DOM å…ƒç´ 
    const drawBtn = document.getElementById('draw-btn');
    const codeInput = document.getElementById('code-input');
    const msgBox = document.getElementById('msg-box');
    const startScreen = document.getElementById('start-screen');
    const slotArea = document.getElementById('slot-machine-area');
    const machineStatus = document.getElementById('machine-status');
    const resultCard = document.getElementById('result-card');
    const overlay = document.getElementById('overlay');
    const slotContainer = document.getElementById('slot-container-el');

    // å•Ÿå‹•æ™‚åµæ¸¬è£ç½® (å¯é¸)
    detectDevice();

    drawBtn.addEventListener('click', startProcess);
    codeInput.addEventListener('keypress', (e) => { if(e.key==='Enter') startProcess(); });

    // è™•ç†è™›æ“¬éµç›¤å½ˆå‡ºå•é¡Œ (æ‰‹æ©Ÿç‰ˆå„ªåŒ–)
    codeInput.addEventListener('focus', () => {
      // åœ¨éƒ¨åˆ†æ‰‹æ©Ÿç€è¦½å™¨ï¼Œéµç›¤å½ˆå‡ºæœƒå£“ç¸®ç•«é¢ï¼Œé€™è£¡å¯ä»¥åšé¡å¤–è™•ç†
      // ç›®å‰ CSS min-height: 100vh å·²ç¶“èƒ½è™•ç†å¤§éƒ¨åˆ†ç‹€æ³
    });

    function startProcess() {
      const code = codeInput.value.trim().toUpperCase();
      if(!code) return showMsg('è«‹è¼¸å…¥åºè™Ÿ', 'error');

      // é—œé–‰éµç›¤ (æ‰‹æ©Ÿé«”é©—å„ªåŒ–)
      codeInput.blur();

      drawBtn.disabled = true;
      drawBtn.textContent = 'é€£ç·šé©—è­‰ä¸­...';
      showMsg('æ­£åœ¨è®€å–è³‡æ–™...', 'normal');

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'draw', code: code })
      })
      .then(res => res.json())
      .then(data => {
        if(data.ok) {
          // é€²å…¥å‹•ç•«
          startScreen.style.display = 'none';
          slotArea.style.display = 'block';
          
          // è‡ªå‹•æ»¾å‹•åˆ°æ‹‰éœ¸æ©Ÿä½ç½® (é¿å…æ‰‹æ©Ÿç•«é¢è·‘æ‰)
          slotArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          runSlotAnimation(data);
        } else {
          showMsg(data.message, 'error');
          drawBtn.disabled = false;
          drawBtn.textContent = 'é–‹å§‹æŠ½ç';
        }
      })
      .catch(err => {
        console.error(err);
        showMsg('ç¶²è·¯é€£ç·šå¤±æ•—', 'error');
        drawBtn.disabled = false;
        drawBtn.textContent = 'é–‹å§‹æŠ½ç';
      });
    }

    async function runSlotAnimation(data) {
      // ç¬¬ä¸€éšæ®µï¼šæŠ½ç¨®é¡
      machineStatus.textContent = 'âœ¨ ç¨®é¡æŠ½é¸ä¸­... âœ¨';
      machineStatus.style.color = '#fff';
      await spinAllReels(POOL_TYPES, data.type);

      await wait(800);

      // ç¬¬äºŒéšæ®µï¼šæŠ½è§’è‰²
      machineStatus.textContent = 'ğŸ’– è§’è‰²å¬å–šä¸­... ğŸ’–';
      machineStatus.style.color = '#ffeb3b'; // é»ƒè‰²é«˜äº®
      await spinAllReels(POOL_LOVELYS, data.color);

      await wait(600);
      showFinalResult(data);
    }

    function spinAllReels(pool, target) {
      return new Promise(resolve => {
        const reels = [
          document.getElementById('reel-1'),
          document.getElementById('reel-2'),
          document.getElementById('reel-3')
        ];

        // å‹•æ…‹ç²å–ç•¶å‰é«˜åº¦ (é€™å°±æ˜¯æ‰‹æ©Ÿ/é›»è…¦è‡ªé©æ‡‰çš„é—œéµ)
        // ç„¡è«– CSS æ€éº¼ç¸®æ”¾ï¼ŒJS é€™è£¡è®€åˆ°çš„éƒ½æ˜¯å¯¦éš›åƒç´ å€¼
        const currentHeight = slotContainer.clientHeight; // æ‰£é™¤ padding å…§éƒ¨é«˜åº¦

        spinOneReel(reels[0], pool, target, 2000, currentHeight);
        spinOneReel(reels[1], pool, target, 2500, currentHeight);
        spinOneReel(reels[2], pool, target, 3000, currentHeight, resolve);
      });
    }

    function spinOneReel(element, pool, target, duration, itemHeight, callback) {
      let html = '';
      // ç”¢ç”Ÿ 30 å€‹éš¨æ©Ÿé …ç›®
      for(let i=0; i<30; i++) {
        const randomItem = pool[Math.floor(Math.random() * pool.length)];
        html += `<div class="slot-item">${randomItem}</div>`;
      }
      // æœ€å¾ŒåŠ ä¸Šç›®æ¨™
      html += `<div class="slot-item" style="color:var(--accent); font-size:1.1em;">${target}</div>`;

      element.innerHTML = html;
      element.style.transition = 'none';
      element.style.transform = 'translateY(0)';
      element.offsetHeight; // Reflow

      // è¨ˆç®—ä½ç§»è·é›¢ï¼šç¸½é …ç›®æ•¸ * å–®é …é«˜åº¦
      // å› ç‚º CSS è£¡ .slot-item height ç¹¼æ‰¿äº† container çš„ heightï¼Œæ‰€ä»¥ç›´æ¥ç”¨ container height è¨ˆç®—
      // é€™è£¡è¦å¾®èª¿ï¼šslotContainer.clientHeight åŒ…å« padding? ä¸ï¼ŒclientHeight æ˜¯ content + padding
      // ä½†æˆ‘å€‘ CSS è¨­å®šäº† box-sizing: border-box åœ¨ .slot-item å—ï¼Ÿ
      // æœ€ä¿éšªçš„æ–¹å¼ï¼šç›´æ¥è®€å–ç¬¬ä¸€å€‹ slot-item çš„é«˜åº¦ (é›–ç„¶ç¾åœ¨é‚„æ²’ render å®Œå¯èƒ½ä¸æº–)
      // æ›¿ä»£æ–¹æ¡ˆï¼šå‚³å…¥çš„ itemHeight æ‡‰è©²è¦æ˜¯ container çš„é«˜åº¦ (å°æ‡‰ CSS var(--slot-height))
      
      const totalItems = 30 + 1; 
      const finalPos = -(totalItems - 1) * itemHeight; // å‘ä¸Šç§»å‹•

      element.style.transition = `transform ${duration}ms cubic-bezier(0.15, 0.9, 0.25, 1)`;
      element.style.transform = `translateY(${finalPos}px)`;

      if(callback) {
        setTimeout(callback, duration);
      }
    }

    function showFinalResult(data) {
      document.getElementById('final-name').textContent = data.display_name;
      document.getElementById('final-detail').textContent = `${data.type} / ${data.color}`;
      document.getElementById('final-code').textContent = data.prize_key;

      const img = document.getElementById('final-img');
      if(data.image_url) {
        img.src = data.image_url;
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }

      overlay.style.display = 'block';
      resultCard.style.display = 'block';
    }

    function showMsg(text, type) {
      msgBox.textContent = text;
      msgBox.className = 'status-msg ' + (type === 'error' ? 'error' : '');
    }

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

    // ç°¡å–®çš„è£ç½®åµæ¸¬ (å¦‚æœä½ éœ€è¦çµ±è¨ˆæˆ–åšç‰¹æ®Šè™•ç†)
    function detectDevice() {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log("Device Detected:", isMobile ? "Mobile" : "Desktop");
      
      // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨ body åŠ  class
      if(isMobile) document.body.classList.add('is-mobile');
    }
  </script>
</body>
</html>
