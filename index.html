<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TWICE â¤ï¸ ONCE I GOCHA</title>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #ff6f91;
      --secondary: #ff9671;
      --accent: #d65db1;
      --bg: #fff0f5;
      --item-height: 120px; 
      --slot-view-height: calc(var(--item-height) * 3);
    }

    body {
      font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(var(--secondary) 1px, transparent 1px);
      background-size: 20px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px 10px 30px 10px;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 500px;
      text-align: center;
      position: relative;
    }

    #start-screen {
      background: white;
      padding: 40px 25px;
      border-radius: 25px;
      box-shadow: 0 10px 30px rgba(214, 93, 177, 0.2);
      border: 3px solid white;
      position: relative;
      z-index: 20;
      margin-bottom: 20px;
    }

    h1 { 
      color: var(--accent); 
      margin-top: 0; 
      font-size: 1.8rem; 
      margin-bottom: 15px;
      line-height: 1.3;
      text-transform: uppercase;
    }

    .promo-link {
      display: inline-block;
      margin-bottom: 25px;
      color: var(--primary);
      text-decoration: none;
      font-size: 1rem;
      font-weight: bold;
      border-bottom: 2px dashed var(--primary);
      padding-bottom: 4px;
      line-height: 1.5;
    }

    /* === åº«å­˜é¡¯ç¤ºå€å„ªåŒ– === */
    #stock-area {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .stock-badge {
      background: #fce4ec;
      border: 2px solid #f8bbd0;
      color: #c2185b;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
    }
    .stock-badge span {
      background: white;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
      color: var(--primary);
      font-family: monospace;
    }
    /* é¸ä¸­ç‹€æ…‹ */
    .stock-badge.active {
      background: var(--primary);
      color: white;
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 4px 10px rgba(255, 111, 145, 0.4);
    }
    .stock-badge.active span {
      color: var(--accent);
    }

    /* === æ–°å¢ï¼šåº«å­˜è©³ç´°é¢æ¿ === */
    #stock-detail-panel {
      display: none;
      background: #fff;
      border: 2px dashed var(--secondary);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      animation: expandDown 0.3s ease-out;
    }
    @keyframes expandDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* å…©æ¬„é¡¯ç¤º */
      gap: 8px;
      text-align: left;
    }
    .detail-item {
      font-size: 0.9rem;
      color: #555;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .detail-item strong {
      color: var(--accent);
    }

    /* è¼¸å…¥æ¡† */
    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 18px;
      font-size: 1.5rem;
      border: 3px solid #eee;
      border-radius: 15px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: var(--accent);
      outline: none;
      margin-bottom: 25px;
    }
    input:focus { border-color: var(--primary); }

    .btn-draw {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 18px 0;
      width: 100%;
      font-size: 1.3rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(255, 111, 145, 0.4);
      transition: 0.2s;
    }
    .btn-draw:disabled { background: #ccc; cursor: wait; transform: none; box-shadow: none; }

    #slot-machine-area {
      display: none;
      background: var(--accent);
      padding: 15px;
      border-radius: 25px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      position: relative;
      margin-bottom: 25px;
    }

    .machine-status {
      color: white;
      font-size: 1.3rem;
      margin-bottom: 15px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      min-height: 1.5em;
    }

    .slot-container {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      background: #222;
      padding: 8px;
      border-radius: 15px;
      border: 6px solid #ffccbc;
      height: var(--slot-view-height);
      overflow: hidden;
      position: relative;
    }

    .win-line-svg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 10;
      pointer-events: none;
    }
    .win-path {
      stroke: rgba(255, 0, 0, 0.8);
      stroke-width: 10;
      stroke-linecap: round;
      fill: none;
      filter: drop-shadow(0 0 8px red);
      opacity: 0;
      transition: opacity 0.5s; 
    }
    .win-path.show { opacity: 1; }

    .slot-container::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 35%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.25), transparent);
      pointer-events: none;
      z-index: 5;
    }

    .reel { background: white; flex: 1; position: relative; overflow: hidden; border-radius: 6px; }
    .reel-strip { position: absolute; top: 0; left: 0; width: 100%; will-change: transform; }
    .slot-item {
      height: var(--item-height);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      box-sizing: border-box; border-bottom: 1px solid #eee; padding: 8px 4px; overflow: hidden; background: white;
    }
    .slot-img { width: 100%; height: 75%; object-fit: contain; flex-shrink: 0; }
    .slot-text { font-size: 0.9rem; color: #333; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 6px; line-height: 1.2; }

    #inline-result-area {
      display: none;
      background: white;
      padding: 30px 20px;
      border-radius: 25px;
      box-shadow: 0 15px 40px rgba(214, 93, 177, 0.3);
      border: 3px solid var(--primary);
      text-align: center;
      animation: slideUp 0.5s ease-out;
      overflow: hidden;
    }

    .screenshot-alert {
      color: #c2185b;
      font-weight: bold;
      font-size: 1.1rem;
      border: 2px dashed var(--primary);
      background-color: #fff0f5;
      padding: 10px;
      border-radius: 10px;
      margin: 15px auto;
      display: inline-block;
      line-height: 1.6;
    }

    .btn-screenshot {
      background: #4caf50;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1.1rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      margin-top: 20px;
      width: 80%;
      transition: 0.2s;
    }
    .btn-screenshot:active { transform: scale(0.95); }
    .btn-screenshot:disabled { background: #ccc; box-shadow: none; cursor: wait; }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .final-prize-img {
      width: 100%;
      max-height: 350px;
      object-fit: contain;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    #img-modal {
      display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      backdrop-filter: blur(5px);
    }
    #img-modal img {
      max-width: 90%; max-height: 80vh; border: 2px solid white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #img-modal p {
      color: white; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;
      background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 50px;
    }
    .close-modal {
      position: absolute; top: 20px; right: 20px;
      color: white; font-size: 30px; cursor: pointer; background: none; border: none;
    }

    .status-msg { margin-top: 15px; color: var(--primary); font-weight: bold; font-size: 1rem; }
    .error { color: #e53935; }

    @media screen and (max-width: 600px) {
      :root { --item-height: 120px; }
      h1 { font-size: 1.6rem; }
      .container { width: 95%; }
      .slot-img { height: 70%; }
      .slot-text { font-size: 0.85rem; margin-top: 8px; line-height: 1.2; }
      .slot-container { border-width: 5px; gap: 4px; }
    }
  </style>
</head>
<body>

  <div class="container">
    
    <div id="start-screen">
      <h1>TWICE â¤ï¸ ONCE I GOCHA</h1>
      <a href="https://www.threads.com/@a27689532/post/DRlXgWvkiG9?xmt=AQF0m11o5sqKyTq1bZQteVidEod1mjd1eYCTce4RUaumCg" 
         target="_blank" class="promo-link">
         ğŸŒŸ å°åŒ—å¤§å·¨è›‹é€±äº”å ´ç·šä¸Šæ‡‰æ´æ–‡ç«  ğŸŒŸ
      </a>
      
      <div id="stock-area">è¼‰å…¥åº«å­˜ä¸­...</div>
      
      <div id="stock-detail-panel"></div>

      <p style="color:#888; font-size:1rem; margin-top:15px;">è¼¸å…¥åºè™Ÿé–‹å§‹è½‰å‹•å¹¸é‹</p>
      <input type="text" id="code-input" placeholder="è«‹è¼¸å…¥åºè™Ÿ" maxlength="8" autocomplete="off">
      <button id="draw-btn" class="btn-draw">é–‹å§‹æŠ½ç</button>
      <div id="msg-box" class="status-msg"></div>
      <div id="loading-hint" style="display:none; color:#aaa; font-size:0.8rem; margin-top:10px;">æ­£åœ¨ä¸‹è¼‰åœ–ç‰‡ç´ æ...</div>
    </div>

    <div id="slot-machine-area">
      <div id="machine-status" class="machine-status">æº–å‚™å•Ÿå‹•...</div>
      <div class="slot-container">
        <svg class="win-line-svg" viewBox="0 0 300 300" preserveAspectRatio="none">
           <path id="win-path" class="win-path" d="" />
        </svg>
        <div class="reel"><div class="reel-strip" id="reel-1"></div></div>
        <div class="reel"><div class="reel-strip" id="reel-2"></div></div>
        <div class="reel"><div class="reel-strip" id="reel-3"></div></div>
      </div>
    </div>

    <div id="inline-result-area">
      <div id="capture-target" style="background:white; padding:15px; border-radius:15px; border: 2px solid #ff6f91;">
        <h2 style="color:var(--secondary); margin:0 0 15px 0; font-size:1.8rem;">ğŸ‰ CONGRATULATIONS!</h2>
        <img id="final-img" class="final-prize-img" src="" alt="Prize">
        
        <h3 id="final-name" style="color:var(--accent); margin:10px 0; font-size:1.6rem;"></h3>
        <p id="final-detail" style="color:#666; margin:5px 0; font-size:1.2rem; font-weight:bold;"></p>
        
        <div style="background:#eee; padding:8px 20px; border-radius:10px; display:inline-block; margin:15px 0;">
          <span style="font-size:1rem;">ä¸­çåºè™Ÿ: </span>
          <strong id="final-code" style="color:#555; font-size:1.2rem; font-family:monospace;"></strong>
        </div>
        
        <br>
        <div class="screenshot-alert">
          âš ï¸ è«‹å‹™å¿…æˆªåœ– âš ï¸<br>
          é€±äº”å ´æ¬¡é ˜å–æ™‚éœ€å‡ºç¤ºæ­¤ç•«é¢
        </div>
      </div>

      <button onclick="generateImageForSave()" class="btn-screenshot">ğŸ“¸ ç”¢ç”Ÿåœ–ç‰‡ (é•·æŒ‰å„²å­˜)</button>
      <button onclick="resetGame()" class="btn-draw" style="margin-top:30px; padding:15px 50px; background:var(--accent);">å†ç©ä¸€æ¬¡</button>
    </div>

  </div>

  <div id="img-modal">
    <button class="close-modal" onclick="closeModal()">Ã—</button>
    <p>ğŸ‘‡ è«‹é•·æŒ‰ä¸‹æ–¹åœ–ç‰‡åŠ å…¥ç…§ç‰‡ ğŸ‘‡</p>
    <div id="generated-img-container"></div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyfF-yGRiOaEwTfb46Riji-ERnQqjhPL_uJ5rVeekGvI1j4-hmfPu3Jr4MkdeqhfcyHtw/exec';

    // stocks: ç¸½åº«å­˜, lovelyStocks: ç´°é …åº«å­˜
    let CATALOG = { types: {}, relations: {}, stocks: {}, lovelyStocks: {} };
    const DEFAULT_TYPES = ['é›¨å‚˜å¨ƒ', 'ä¸‰éº—é·—', 'é¾è¦æ‰£', 'è»Ÿç³–', 'å·§å…‹åŠ›', 'é¤…ä¹¾', 'è»Šè»Š', 'æ¨¡å‹åŒ…'];
    const DEFAULT_LOVELYS = ['SAVELY', 'TZUVELY', 'MIVELY', 'JIVELY', 'CHAENG', 'DAHYUN', 'NAYEON', 'JEONG'];

    const WIN_PATTERNS = [
      { name: 'MIDDLE', rows: [1, 1, 1], svg: 'M0,150 L300,150' },
      { name: 'TOP',    rows: [0, 0, 0], svg: 'M0,50 L300,50' },
      { name: 'BOTTOM', rows: [2, 2, 2], svg: 'M0,250 L300,250' },
      { name: 'DIAG_TL',rows: [0, 1, 2], svg: 'M0,50 L300,250' },
      { name: 'DIAG_BL',rows: [2, 1, 0], svg: 'M0,250 L300,50' }
    ];

    const drawBtn = document.getElementById('draw-btn');
    const codeInput = document.getElementById('code-input');
    const msgBox = document.getElementById('msg-box');
    const startScreen = document.getElementById('start-screen');
    const slotArea = document.getElementById('slot-machine-area');
    const machineStatus = document.getElementById('machine-status');
    const loadingHint = document.getElementById('loading-hint');
    const winPath = document.getElementById('win-path');
    const stockArea = document.getElementById('stock-area');
    const stockDetailPanel = document.getElementById('stock-detail-panel');
    const inlineResultArea = document.getElementById('inline-result-area');
    const imgModal = document.getElementById('img-modal');
    const genImgContainer = document.getElementById('generated-img-container');
    const screenshotBtn = document.querySelector('.btn-screenshot');

    let activeStockType = null; // è¨˜éŒ„ç›®å‰å±•é–‹çš„åº«å­˜é¡å‹

    window.onload = function() { fetchCatalog(); };

    function fetchCatalog() {
      loadingHint.style.display = 'block';
      drawBtn.disabled = true;
      fetch(API_URL + '?action=catalog')
        .then(res => res.json())
        .then(data => {
          if(data.ok) {
            processCatalog(data);
            renderStocks();
            loadingHint.style.display = 'none';
            drawBtn.disabled = false;
          } else {
            loadingHint.textContent = 'ä½¿ç”¨ç´”æ–‡å­—æ¨¡å¼';
            stockArea.textContent = 'åº«å­˜è³‡è¨Šç„¡æ³•è¼‰å…¥';
            drawBtn.disabled = false;
          }
        })
        .catch(err => {
          loadingHint.textContent = 'é€£ç·šç•°å¸¸';
          drawBtn.disabled = false;
        });
    }

    function processCatalog(data) {
      if (data.typeImages) {
        for (const [type, imgs] of Object.entries(data.typeImages)) {
          if (imgs && imgs.length > 0) CATALOG.types[type] = imgs;
        }
      }
      if (data.typeLovelyImages) CATALOG.relations = data.typeLovelyImages;
      if (data.typeStocks) CATALOG.stocks = data.typeStocks;
      if (data.typeLovelyStocks) CATALOG.lovelyStocks = data.typeLovelyStocks;
    }

    function renderStocks() {
      stockArea.innerHTML = '';
      const stocks = CATALOG.stocks;
      const total = Object.values(stocks).reduce((sum, val) => sum + val, 0);
      if (total === 0) { stockArea.textContent = 'ç›®å‰å·²ç„¡åº«å­˜'; return; }
      
      for (const [type, count] of Object.entries(stocks)) {
        if (count > 0) {
          const probability = ((count / total) * 100).toFixed(1);
          const badge = document.createElement('div');
          badge.className = 'stock-badge';
          if(type === activeStockType) badge.classList.add('active');
          
          badge.innerHTML = `${type} <span>${count} (${probability}%)</span>`;
          
          // é»æ“Šäº‹ä»¶ï¼šå±•é–‹è©³ç´°åº«å­˜
          badge.onclick = () => toggleStockDetail(type);
          
          stockArea.appendChild(badge);
        }
      }
      // å¦‚æœç›®å‰æœ‰å±•é–‹ï¼Œå‰‡é‡æ–°æ¸²æŸ“è©³ç´°é¢æ¿ (ç¢ºä¿æ•¸å­—æ˜¯æœ€æ–°çš„)
      if (activeStockType) renderDetailPanel();
    }

    // === åˆ‡æ›è©³ç´°åº«å­˜é¢æ¿ ===
    function toggleStockDetail(type) {
      if (activeStockType === type) {
        // å†æ¬¡é»æ“ŠåŒä¸€å€‹ -> é—œé–‰
        activeStockType = null;
        stockDetailPanel.style.display = 'none';
      } else {
        // é»æ“Šæ–°çš„ -> é–‹å•Ÿ
        activeStockType = type;
        stockDetailPanel.style.display = 'block';
        renderDetailPanel();
      }
      renderStocks(); // é‡æ–°æ¸²æŸ“ä¸Šé¢çš„æŒ‰éˆ•ä»¥é¡¯ç¤º active ç‹€æ…‹
    }

    function renderDetailPanel() {
      if (!activeStockType) return;
      const details = CATALOG.lovelyStocks[activeStockType] || {};
      
      // å¦‚æœè©²ç¨®é¡å®Œå…¨æ²’ç´°é …è³‡æ–™
      if (Object.keys(details).length === 0) {
        stockDetailPanel.innerHTML = '<div style="color:#888;">å°šç„¡è©³ç´°è³‡æ–™</div>';
        return;
      }

      let html = `<div class="detail-grid">`;
      for (const [lovelys, count] of Object.entries(details)) {
        html += `<div class="detail-item"><strong>${lovelys}</strong>: ${count}</div>`;
      }
      html += `</div>`;
      stockDetailPanel.innerHTML = html;
    }

    drawBtn.addEventListener('click', startProcess);
    codeInput.addEventListener('keypress', (e) => { if(e.key==='Enter') startProcess(); });

    function resetGame() {
      inlineResultArea.style.display = 'none';
      slotArea.style.display = 'none';
      startScreen.style.display = 'block';
      codeInput.value = '';
      msgBox.textContent = '';
      drawBtn.disabled = false;
      drawBtn.textContent = 'é–‹å§‹æŠ½ç';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function getBase64Image(url) {
      const response = await fetch(url);
      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function generateImageForSave() {
      const target = document.getElementById('capture-target');
      const originalText = screenshotBtn.textContent;
      screenshotBtn.textContent = 'ğŸ“¸ è™•ç†ä¸­...';
      screenshotBtn.disabled = true;

      html2canvas(target, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
        try {
          const imgUrl = canvas.toDataURL("image/png");
          genImgContainer.innerHTML = `<img src="${imgUrl}" alt="Result Screenshot">`;
          imgModal.style.display = 'flex';
          screenshotBtn.textContent = originalText;
          screenshotBtn.disabled = false;
        } catch (e) {
          alert('åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿæˆªåœ–åŠŸèƒ½ä¿å­˜ç•«é¢ï¼');
          screenshotBtn.textContent = originalText;
          screenshotBtn.disabled = false;
        }
      }).catch(err => {
        console.error(err);
        alert('æˆªåœ–ç”Ÿæˆå¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–ï¼');
        screenshotBtn.textContent = originalText;
        screenshotBtn.disabled = false;
      });
    }

    function closeModal() {
      imgModal.style.display = 'none';
    }

    function startProcess() {
      const code = codeInput.value.trim().toUpperCase();
      if(!code) return showMsg('è«‹è¼¸å…¥åºè™Ÿ', 'error');
      inlineResultArea.style.display = 'none';
      codeInput.blur();
      drawBtn.disabled = true;
      drawBtn.textContent = 'é©—è­‰åºè™Ÿä¸­...';
      showMsg('', 'normal');

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'draw', code: code })
      })
      .then(res => res.json())
      .then(data => {
        if(data.ok) {
          startScreen.style.display = 'none';
          slotArea.style.display = 'block';
          setTimeout(() => slotArea.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
          runSlotAnimation(data);
        } else {
          showMsg(data.message, 'error');
          drawBtn.disabled = false;
          drawBtn.textContent = 'é–‹å§‹æŠ½ç';
        }
      })
      .catch(err => {
        showMsg('ç¶²è·¯éŒ¯èª¤', 'error');
        drawBtn.disabled = false;
        drawBtn.textContent = 'é–‹å§‹æŠ½ç';
      });
    }

    async function runSlotAnimation(data) {
      const pattern = WIN_PATTERNS[Math.floor(Math.random() * WIN_PATTERNS.length)];
      winPath.setAttribute('d', pattern.svg);
      winPath.classList.remove('show'); 

      const typeKeys = Object.keys(CATALOG.types).length > 0 ? Object.keys(CATALOG.types) : DEFAULT_TYPES;
      
      machineStatus.textContent = 'âœ¨ æŠ½é¸ç¨®é¡ä¸­... âœ¨';
      await spinAllReels(typeKeys, data.type, 'TYPE', pattern, null);

      winPath.classList.add('show');
      await wait(1500); 
      winPath.classList.remove('show'); 
      await wait(600);
      
      let colorKeys = DEFAULT_LOVELYS;
      if (CATALOG.relations[data.type]) {
        const keys = Object.keys(CATALOG.relations[data.type]);
        if (keys.length > 0) colorKeys = keys;
      }

      machineStatus.textContent = 'ğŸ’– å¬å–š LOVELYS... ğŸ’–';
      machineStatus.style.color = '#ffeb3b';
      
      const pattern2 = WIN_PATTERNS[Math.floor(Math.random() * WIN_PATTERNS.length)];
      winPath.setAttribute('d', pattern2.svg);
      
      await spinAllReels(colorKeys, data.color, 'COLOR', pattern2, data.type);

      winPath.classList.add('show');
      await wait(800);
      showFinalResult(data);
    }

    function spinAllReels(poolKeys, targetText, mode, pattern, contextType) {
      return new Promise(resolve => {
        const reels = [
          document.getElementById('reel-1'),
          document.getElementById('reel-2'),
          document.getElementById('reel-3')
        ];
        const durations = [3000, 4500, 6000];
        const style = getComputedStyle(document.documentElement);
        const itemHeight = parseInt(style.getPropertyValue('--item-height')) || 100;
        spinOneReel(reels[0], poolKeys, targetText, mode, durations[0], itemHeight, pattern.rows[0], null, contextType);
        spinOneReel(reels[1], poolKeys, targetText, mode, durations[1], itemHeight, pattern.rows[1], null, contextType);
        spinOneReel(reels[2], poolKeys, targetText, mode, durations[2], itemHeight, pattern.rows[2], resolve, contextType);
      });
    }

    function spinOneReel(element, pool, target, mode, duration, itemHeight, targetRowIndex, callback, contextType) {
      let html = '';
      const count = 40; 
      for(let i=0; i<count; i++) {
        const randomKey = pool[Math.floor(Math.random() * pool.length)];
        const imgUrl = getRandomImg(mode, randomKey, contextType);
        html += createSlotItemHtml(randomKey, imgUrl);
      }
      const prevKey = pool[Math.floor(Math.random() * pool.length)];
      html += createSlotItemHtml(prevKey, getRandomImg(mode, prevKey, contextType));
      html += createSlotItemHtml(target, getRandomImg(mode, target, contextType));
      for(let k=0; k<3; k++) {
        const nextKey = pool[Math.floor(Math.random() * pool.length)];
        html += createSlotItemHtml(nextKey, getRandomImg(mode, nextKey, contextType));
      }
      element.innerHTML = html;
      element.style.transition = 'none';
      element.style.transform = 'translateY(0)';
      element.offsetHeight; 
      const finalY = (targetRowIndex * itemHeight) - ((count + 1) * itemHeight);
      element.style.transition = `transform ${duration}ms cubic-bezier(0.15, 0.9, 0.30, 1)`;
      element.style.transform = `translateY(${finalY}px)`;
      if(callback) { setTimeout(callback, duration); }
    }

    function getRandomImg(mode, key, contextType) {
      if (mode === 'TYPE') {
        const arr = CATALOG.types[key];
        if (arr && arr.length > 0) return arr[Math.floor(Math.random() * arr.length)];
      } 
      else if (mode === 'COLOR') {
        if (contextType && CATALOG.relations[contextType]) {
          const arr = CATALOG.relations[contextType][key];
          if (arr && arr.length > 0) return arr[Math.floor(Math.random() * arr.length)];
        }
      }
      return '';
    }

    function createSlotItemHtml(text, imgUrl) {
      let content = '';
      if (imgUrl) {
        content = `<img src="${imgUrl}" class="slot-img" alt="${text}"><div class="slot-text">${text}</div>`;
      } else {
        content = `<div style="font-size:1.5rem; color:#d65db1;">${text}</div>`;
      }
      return `<div class="slot-item">${content}</div>`;
    }

    function showFinalResult(data) {
      document.getElementById('final-name').textContent = data.display_name;
      document.getElementById('final-detail').textContent = `${data.type} / ${data.color}`;
      document.getElementById('final-code').textContent = data.prize_key;

      const img = document.getElementById('final-img');
      let safeImgUrl = '';
      if (CATALOG.relations[data.type] && CATALOG.relations[data.type][data.color]) {
         const arr = CATALOG.relations[data.type][data.color];
         if (arr.length > 0) safeImgUrl = arr[0];
      }
      if (!safeImgUrl) safeImgUrl = data.image_url;

      if(safeImgUrl) {
        img.src = safeImgUrl;
        img.style.display = 'block';
        screenshotBtn.disabled = true;
        screenshotBtn.textContent = 'ğŸ”„ æº–å‚™åœ–ç‰‡ä¸­...';
        
        getBase64Image(safeImgUrl)
          .then(base64Data => {
            img.src = base64Data;
            screenshotBtn.disabled = false;
            screenshotBtn.textContent = 'ğŸ“¸ ç”¢ç”Ÿåœ–ç‰‡ (é•·æŒ‰å„²å­˜)';
          })
          .catch(err => {
            console.error("Base64 convert failed", err);
            screenshotBtn.disabled = false;
            screenshotBtn.textContent = 'ğŸ“¸ ç”¢ç”Ÿåœ–ç‰‡ (é•·æŒ‰å„²å­˜)';
          });
      } else {
        img.style.display = 'none';
        screenshotBtn.disabled = false;
      }

      // === æ‰£åº«å­˜é‚è¼¯ ===
      // 1. æ‰£ç¸½åº«å­˜
      if (CATALOG.stocks[data.type]) {
        CATALOG.stocks[data.type]--;
        if (CATALOG.stocks[data.type] < 0) CATALOG.stocks[data.type] = 0;
      }
      // 2. æ‰£ç´°é …åº«å­˜
      if (CATALOG.lovelyStocks[data.type] && CATALOG.lovelyStocks[data.type][data.color]) {
        CATALOG.lovelyStocks[data.type][data.color]--;
        if (CATALOG.lovelyStocks[data.type][data.color] < 0) CATALOG.lovelyStocks[data.type][data.color] = 0;
      }

      // é‡æ–°æ¸²æŸ“åº«å­˜èˆ‡é¢æ¿
      renderStocks();

      inlineResultArea.style.display = 'block';
      setTimeout(() => { inlineResultArea.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
    }

    function showMsg(text, type) {
      msgBox.textContent = text;
      msgBox.className = 'status-msg ' + (type === 'error' ? 'error' : '');
    }

    function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
  </script>
</body>
</html>
